{% extends 'base.html' %}
{% block content %}
<h3>Resumen mensual</h3>
<form class="row g-2 mb-3" method="get" action="/">
  
<div class="col-auto">
  <label class="form-label">Año</label>
  <select name="year" class="form-control form-select">
    <option value="1313"  {% for y in range(2025, 2028) %}>Todos</option>
    <option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>{% endfor %}
  </select>
 
<!-- <input type="number" name="year" value="{{ year }}" class="form-control"/>-->
</div>

<div class="col-auto">
  <label class="form-label">Mes</label>
  <select name="month" class="form-control form-select">
    <!-- "Todos" -> valor vacío -->
    <!-- <option value="" {% if not month %}selected{% endif %}>Todos</option>-->

    <!-- Meses 0..12 -->
    <option value="13"  {% if (month|string) == '13'  %}selected{% endif %}>Todos</option>
    <option value="1"  {% if (month|string) == '1'  %}selected{% endif %}>Enero</option>
    <option value="2"  {% if (month|string) == '2'  %}selected{% endif %}>Febrero</option>
    <option value="3"  {% if (month|string) == '3'  %}selected{% endif %}>Marzo</option>
    <option value="4"  {% if (month|string) == '4'  %}selected{% endif %}>Abril</option>
    <option value="5"  {% if (month|string) == '5'  %}selected{% endif %}>Mayo</option>
    <option value="6"  {% if (month|string) == '6'  %}selected{% endif %}>Junio</option>
    <option value="7"  {% if (month|string) == '7'  %}selected{% endif %}>Julio</option>
    <option value="8"  {% if (month|string) == '8'  %}selected{% endif %}>Agosto</option>
    <option value="9"  {% if (month|string) == '9'  %}selected{% endif %}>Septiembre</option>
    <option value="10" {% if (month|string) == '10' %}selected{% endif %}>Octubre</option>
    <option value="11" {% if (month|string) == '11' %}selected{% endif %}>Noviembre</option>
    <option value="12" {% if (month|string) == '12' %}selected{% endif %}>Diciembre</option>
  </select>
</div>

  <div class="col-auto align-self-end d-flex gap-2">
    <button class="btn btn-primary">Aplicar</button>
    <a class="btn btn-outline-primary" href="{{ url_for('dashboard_export', year=year, month=month, format='csv') }}">Exportar CSV</a>
    <a class="btn btn-outline-success" href="{{ url_for('dashboard_export', year=year, month=month, format='xlsx') }}">Exportar Excel</a>
  </div>
</form>

<div class="row g-3">
  <div class="col-md-3">
    <div class="card"><div class="card-body">
        <h6>Ventas (total)</h6>
      <div class="fs-5">{{ ventas_tot['monto_total'] | ars }}</div>
      <small class="text-muted">IVA: {{ ventas_tot['iva'] | ars }}</small>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card"><div class="card-body">
        <h6>Compras (total)</h6>
      <div class="fs-5">{{ compras_tot['monto_total'] | ars }}</div>
      <small class="text-muted">IVA: {{ compras_tot['iva'] | ars }}</small><br>
      <small class="text-muted">IVA deducible (emp.): {{ compras_tot['iva_deducible'] | ars }}</small>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card"><div class="card-body">
      <h6>Ganancia neta s/IVA</h6>
      <div class="fs-5">{{ ganancia_neta | ars }}</div>
      <small class="text-muted">Ventas s/IVA: {{ ventas_sin_iva | ars }}</small><br>
      <small class="text-muted">Compras s/IVA: {{ compras_sin_iva | ars }}</small>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <h6>IVA a pagar</h6>
        <div class="fs-5">{{ iva_a_pagar | ars }}</div>
        <small class="text-muted">Venta - (Compra + 50% IVA pers.)</small>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-2">
  <div class="col-md-6">
    <div class="card border-warning">
      <div class="card-body">
        <h6>Alertas</h6>
        <div style="margin-bottom: 10px;">Compras ADEUDADAS: <span class="badge bg-warning text-dark" style="font-size: 1rem;">{{ adeudado_compras }}</span></div>
        <div style="margin-bottom: 10px;">Ventas ADEUDADAS: <span class="badge bg-warning text-dark" style="font-size: 1rem;">{{ adeudado_ventas }}</span></div>
      </div>
    </div>
  </div>
</div>

<h4 class="mt-4">Por socio</h4>
<div class="table-responsive">
<table class="table table-sm table-striped">
  <thead>
    <tr>
      <th>Socio</th>
      <th class="text-end">Ventas s/IVA</th>
      <th class="text-end">Compras s/IVA</th>
      
    </tr>
  </thead>
  <tbody>
    {% for item in per_socio %}
    <tr>
      <td>{{ item.nombre }}</td>
      <td class="text-end">{{ item.ventas_sin_iva | ars }}</td>
      <td class="text-end">{{ item.compras_sin_iva | ars }}</td>
      
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>

{% if debug %}
<div class="alert alert-info mt-4">
  <h5>Debug info</h5>
  <ul>
    <li>Año: {{ year }}</li>
    <li>Mes: {{ month }}</li>
    <li>YM: {{ year|string ~ '-' ~ (month|string).zfill(2) }}</li>
    <li>Compras cargadas: {{ compras_sin_iva }}</li>
    <li>Ventas cargadas: {{ ventas_sin_iva }}</li>
  </ul>
</div>
{% endif %}

{% endblock %}
